<div class="container">
  <div class="main-content">
    <h1>Vessel Tracker</h1>

    <div class="refresh-container">
      <button (click)="loadVesselPositions()" class="refresh-button">
        Refresh Vessel Positions
      </button>
      <button (click)="getVesselInfo()" class="refresh-button">
        Get Vessel Info
      </button>
      <button (click)="addVessel()" class="refresh-button">
        Add Vessels
      </button>
    </div>

    @if (error) {
    <div class="error-message">
      {{ error }}
    </div>
    }

    @if (!activeSection) {
    <div class="loading">
      Select options above to view vessel positions, get vessel info, or add vessels.
    </div>
    }

    @if (activeSection === 'positions') {
    @if (!vesselPositions.length) {
    <div class="loading">
      Loading vessel positions...
    </div>
    } @else {
    <div class="vessel-table-container">
      <h2>Vessel Positions ({{ vesselPositions.length }} vessels)</h2>
      <table class="vessel-table">
        <thead>
          <tr>
            <th (click)="sortVessels('name')" class="sortable">
              Vessel Name
              <span *ngIf="sortColumn === 'name'" class="sort-indicator">
                {{ sortDirection === 'asc' ? '▲' : '▼' }}
              </span>
            </th>
            <th (click)="sortVessels('position')" class="sortable">
              Position
              <span *ngIf="sortColumn === 'position'" class="sort-indicator">
                {{ sortDirection === 'asc' ? '▲' : '▼' }}
              </span>
            </th>
            <th (click)="sortVessels('speed')" class="sortable">
              Speed
              <span *ngIf="sortColumn === 'speed'" class="sort-indicator">
                {{ sortDirection === 'asc' ? '▲' : '▼' }}
              </span>
            </th>
            <th (click)="sortVessels('course')" class="sortable">
              Course
              <span *ngIf="sortColumn === 'course'" class="sort-indicator">
                {{ sortDirection === 'asc' ? '▲' : '▼' }}
              </span>
            </th>
            <th (click)="sortVessels('lastUpdated')" class="sortable">
              Last Updated
              <span *ngIf="sortColumn === 'lastUpdated'" class="sort-indicator">
                {{ sortDirection === 'asc' ? '▲' : '▼' }}
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          @for (vessel of vesselPositions; track vessel.aisStatic?.imo) {
          <tr>
            <td>{{ vessel.aisStatic?.name || 'Unknown Vessel' }}</td>
            <td>
              @if (vessel.aisPosition?.lat && vessel.aisPosition?.lon) {
              <a href="https://www.google.com/maps?q={{vessel.aisPosition.lat}},{{vessel.aisPosition.lon}}"
                target="_blank">
                {{ vessel.aisPosition.lat.toFixed(4) }}°N, {{ vessel.aisPosition.lon.toFixed(4) }}°E
              </a>
              } @else {
              N/A
              }
            </td>
            <td>{{ getFormattedSpeed(vessel.aisPosition?.sog) }}</td>
            <td>{{ vessel.aisPosition?.cog?.toFixed(1) || 'N/A' }}°</td>
            <td>{{ getFormattedDate(vessel.aisPosition?.timeReceived) }}</td>
          </tr>
          }
        </tbody>
      </table>
      <div class="table-navigation">
        <button (click)="scrollToTableTop()" class="nav-arrow up-arrow" title="Scroll to top">↑</button>
        <button (click)="scrollToTableBottom()" class="nav-arrow down-arrow" title="Scroll to bottom">↓</button>
      </div>
    </div>
    }
    }

    @if (activeSection === 'info' && vesselInfo.length > 0) {
    <div class="vessel-info-section">
      <h2>Vessel Information</h2>
      @for (vessel of vesselInfo; track vessel.aisStatic.imo) {
      <div class="vessel-card">
        <h3>{{ vessel.aisStatic.name }}</h3>
        <div class="vessel-details">
          <div class="detail-group">
            <h4>Basic Information</h4>
            <p><strong>IMO:</strong> {{ vessel.aisStatic.imo }}</p>
            <p><strong>MMSI:</strong> {{ vessel.aisStatic.mmsi }}</p>
            <p><strong>Callsign:</strong> {{ vessel.aisStatic.callsign }}</p>
            <p><strong>Flag:</strong> {{ vessel.aisStatic.flag }}</p>
            <p><strong>Type:</strong> {{ vessel.aisStatic.aisShiptype }}</p>
            <p><strong>Dimensions:</strong> {{ getFormattedDimensions(vessel.aisStatic.length, vessel.aisStatic.width)
              }}</p>
            <p><strong>Tonnage:</strong> {{ getFormattedTonnage(vessel.vesselDetails.deadWeight,
              vessel.vesselDetails.grossTonnage) }}</p>
            <p><strong>TEU Capacity:</strong> {{ vessel.vesselDetails.teu?.toLocaleString() || 'N/A' }}</p>
          </div>

          <div class="detail-group">
            <h4>Current Position</h4>
            <p><strong>Location:</strong> {{ vessel.aisPosition.lat.toFixed(4) }}°N, {{
              vessel.aisPosition.lon.toFixed(4) }}°E</p>
            <p><strong>Speed:</strong> {{ getFormattedSpeed(vessel.aisPosition.sog) }}</p>
            <p><strong>Course:</strong> {{ vessel.aisPosition.cog.toFixed(1) }}°</p>
            <p><strong>Heading:</strong> {{ vessel.aisPosition.hdg.toFixed(1) }}°</p>
            <p><strong>Last Update:</strong> {{ getFormattedDate(vessel.aisPosition.timeReceived) }}</p>
          </div>

          <div class="detail-group">
            <h4>Port Information</h4>
            <p><strong>Current Port:</strong> {{ vessel.geoDetails.currentPort }}</p>
            <p><strong>Current Berth:</strong> {{ vessel.geoDetails.currentBerth }}</p>
            <p><strong>Status:</strong> {{ vessel.geoDetails.status }}</p>
            <p><strong>Port Country:</strong> {{ vessel.geoDetails.portCountry }}</p>
          </div>

          <div class="detail-group">
            <h4>Voyage Information</h4>
            <p><strong>Destination:</strong> {{ vessel.voyageDetails.destination }}</p>
            <p><strong>ETA:</strong> {{ getFormattedDate(vessel.voyageDetails.calculatedEta) }}</p>
            <p><strong>Last Port:</strong> {{ vessel.voyageDetails.lastPort }}</p>
            <p><strong>Last Port Departure:</strong> {{ getFormattedDate(vessel.voyageDetails.lastPortDepartureTime) }}
            </p>
          </div>
        </div>
      </div>
      }
    </div>
    }

    @if (activeSection === 'add' && addVesselResult) {
    <div class="vessel-info-section">
      <h2>Add Vessels Result</h2>
      <pre>{{ addVesselResult | json }}</pre>
    </div>
    }
  </div>

  <div class="imo-input-section">
    <h3>IMO Numbers</h3>
    <p class="hint">Enter one IMO number per line</p>
    <textarea [(ngModel)]="imoList" (ngModelChange)="updateImoArray()" placeholder="Enter IMO numbers here..."
      class="imo-textarea">
    </textarea>
  </div>
</div>

<router-outlet />